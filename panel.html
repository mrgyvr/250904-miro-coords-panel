<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CoordsPanel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root { color-scheme: light dark; }
      body { margin:0; font:13px/1.5 system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
      .wrap { padding:12px; width:340px; box-sizing:border-box; }
      h3 { margin:0 0 8px; font-size:14px; }
      label { display:block; font-weight:600; margin:10px 0 4px; }
      input[type="text"] {
        width:100%; padding:8px; border:1px solid #dcdfe3; border-radius:6px;
        box-sizing:border-box; color:#111; background:#fff;
      }
      input[readonly] { background:rgba(0,0,0,0.03); }
      .grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
      .row { display:flex; gap:8px; align-items:center; }
      button {
        padding:6px 10px; border:1px solid #dcdfe3; border-radius:6px;
        background:#fff; color:#111; cursor:pointer;
      }
      .muted { opacity:.7; font-size:12px; }
      .spacer { height:8px; }
      .mono { font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; }
      @media (prefers-color-scheme: dark) {
        input[type="text"] { background:#1f2227; border-color:#3a3f46; color:#eaeef3; }
        input[readonly] { background:#262a30; }
        button { background:#2a2f36; border-color:#3a3f46; color:#eaeef3; }
      }
    </style>
    <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
  </head>
  <body>
    <div class="wrap">
      <h3>CoordsPanel</h3>

      <div id="status" class="muted">Select any item on the board…</div>

      <div class="grid">
        <div>
          <label for="cx">Center X</label>
          <input id="cx" type="text" class="mono" readonly />
        </div>
        <div>
          <label for="cy">Center Y</label>
          <input id="cy" type="text" class="mono" readonly />
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label for="z">Zoom (z)</label>
          <!-- value is set in JS to make it a real default, not just placeholder -->
          <input id="z" type="text" class="mono" placeholder="1" />
        </div>
        <div style="width:120px">
          <label>&nbsp;</label>
          <button id="resetZ" type="button">Reset to 1</button>
        </div>
      </div>

      <label for="baseUrl">Your page URL (with embedded board)</label>
      <input
        id="baseUrl"
        type="text"
        placeholder="https://parkerthatch.com/pages/pt-mood-board"
      />

      <label for="shareUrl">Shareable link</label>
      <input id="shareUrl" type="text" class="mono" readonly />

      <div class="row">
        <button id="copy" type="button">Copy</button>
        <span id="hint" class="muted"></span>
      </div>

      <div class="spacer"></div>
      <div class="muted">Tip: Link updates whenever selection or inputs change.</div>
    </div>

    <script type="module">
      const DEFAULT_BASE_URL = "https://parkerthatch.com/pages/pt-mood-board";
      const DEFAULT_Z = "1";

      const statusEl = document.getElementById('status');
      const cxEl = document.getElementById('cx');
      const cyEl = document.getElementById('cy');
      const zEl = document.getElementById('z');
      const baseUrlEl = document.getElementById('baseUrl');
      const shareUrlEl = document.getElementById('shareUrl');
      const copyBtn = document.getElementById('copy');
      const resetZBtn = document.getElementById('resetZ');
      const hintEl = document.getElementById('hint');

      // ✅ Make defaults real values (not just placeholders)
      if (!baseUrlEl.value) baseUrlEl.value = DEFAULT_BASE_URL;
      if (!zEl.value) zEl.value = DEFAULT_Z;

      const getZoom = () => {
        const v = (zEl.value || '').trim();
        const n = Number(v);
        return Number.isFinite(n) && n > 0 ? n : 1;
      };
      const fmt = (n) => Number(n.toFixed(2)).toString();

      function buildLink(sel) {
        shareUrlEl.value = '';
        hintEl.textContent = '';

        const raw = (baseUrlEl.value || '').trim();
        if (!raw) { hintEl.textContent = 'Enter your page URL above.'; return; }

        if (!sel || typeof sel.x !== 'number' || typeof sel.y !== 'number') {
          hintEl.textContent = 'Select an item to generate link.'; return;
        }

        let u;
        try { u = new URL(raw, location.href); }
        catch { hintEl.textContent = 'Base URL is not valid.'; return; }

        u.searchParams.set('cx', fmt(sel.x));
        u.searchParams.set('cy', fmt(sel.y));
        u.searchParams.set('z', fmt(getZoom()));
        shareUrlEl.value = u.href;
      }

      async function syncAndRender(it) {
        if (!it) {
          cxEl.value = ''; cyEl.value = '';
          statusEl.textContent = 'Select any item on the board…';
          buildLink(null);
          return;
        }
        try { await it.sync?.(); } catch {}
        const x = Number(it.x ?? NaN);
        const y = Number(it.y ?? NaN);
        if (!Number.isFinite(x) || !Number.isFinite(y)) {
          statusEl.textContent = 'Item has no coordinates yet.';
          cxEl.value = ''; cyEl.value = '';
          buildLink(null);
          return;
        }
        cxEl.value = fmt(x);
        cyEl.value = fmt(y);
        statusEl.textContent = `Selected: ${it.type} (${it.id.slice(0,6)}…)`;
        buildLink({ x, y });
      }

      // Rebuild link when inputs change
      [baseUrlEl, zEl].forEach(el => el.addEventListener('input', () => {
        const x = parseFloat(cxEl.value), y = parseFloat(cyEl.value);
        if (Number.isFinite(x) && Number.isFinite(y)) buildLink({ x, y });
        else buildLink(null);
      }));
      resetZBtn.addEventListener('click', () => {
        zEl.value = DEFAULT_Z;
        const x = parseFloat(cxEl.value), y = parseFloat(cyEl.value);
        if (Number.isFinite(x) && Number.isFinite(y)) buildLink({ x, y });
      });

      // ✅ Robust full-copy logic (works across browsers)
      copyBtn.addEventListener('click', async () => {
        const val = shareUrlEl.value;
        if (!val) return;
        try {
          await navigator.clipboard.writeText(val);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 900);
        } catch {
          // Fallback: hidden textarea ensures full string copies
          const ta = document.createElement('textarea');
          ta.value = val;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          ta.setSelectionRange(0, ta.value.length);
          try { document.execCommand('copy'); } catch {}
          document.body.removeChild(ta);
          copyBtn.textContent = 'Copied!';
          setTimeout(() => { copyBtn.textContent = 'Copy'; }, 900);
        }
      });

      // Initial selection + live updates
      (async () => {
        try {
          const sel = await miro.board.getSelection();
          await syncAndRender(sel[0] || null);
        } catch (e) {
          statusEl.textContent = 'Unable to read selection. Do you have boards:read scope?';
        }
      })();

      miro.board.ui.on('selection:update', async (e) => {
        const it = e.items?.[0] || null;
        await syncAndRender(it);
      });
    </script>
  </body>
</html>
