<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Coords Panel – Entrypoint (Auto-start)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <script type="module">
      // Cache-bust panel while testing so updates always show
      const PANEL_URL = `panel.html?v=${Date.now()}`;

      async function boot() {
        try {
          // Optional: wait for SDK readiness if available
          if (typeof miro?.onReady === 'function') {
            await miro.onReady();
          }

          // Register toolbar icon → open panel
          miro.board.ui.on('icon:click', () => {
            miro.board.ui.openPanel({ url: PANEL_URL }).catch(() => {});
          });

          // TEMP: auto-open panel so you can see it immediately
          await miro.board.ui.openPanel({ url: PANEL_URL });

          // Visible confirmation in the board UI
          await miro.board.notifications.showInfo('Coords Panel loaded ✅');

          return true;
        } catch (e) {
          // If the SDK isn't ready yet, let the poller retry
          return false;
        }
      }

      // Poll for the SDK to be injected into this iframe
      let tries = 0;
      const maxTries = 60; // ~12s total at 200ms
      const timer = setInterval(async () => {
        if (window.miro && window.miro.board) {
          const ok = await boot();
          if (ok) clearInterval(timer);
        }
        if (++tries >= maxTries) {
          clearInterval(timer);
          // Optional: show a message if we never saw the SDK
          // (You won't see this in the board UI; this iframe is headless.)
          console.log('Coords Panel: SDK not detected in this iframe after waiting.');
        }
      }, 200);
    </script>
  </body>
</html>
