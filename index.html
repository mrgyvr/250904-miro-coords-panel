<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>CoordsPanel – Entrypoint (safe)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Keep SDK include: harmless if injected, essential if not -->
    <script src="https://miro.com/app/static/sdk/v2/miro.js"></script>
  </head>
  <body>
    <script type="module">
      // ⬇️ If your file is actually frame.html, change this.
      const PANEL_FILE = 'panel.html';

      // Build ABSOLUTE URL to the panel file with cache-buster
      const PANEL_URL = new URL(`${PANEL_FILE}?v=${Date.now()}`, import.meta.url).href;

      // Tiny fallback panel (data URL) if fetching your file fails
      const FALLBACK_URL =
        'data:text/html;charset=utf-8,' +
        encodeURIComponent(`<!doctype html><meta charset="utf-8">
          <div style="font:14px system-ui;padding:12px">
            <b>CoordsPanel</b><br>Fallback panel is open.<br>
            If you intended <code>${PANEL_FILE}</code>, check the filename & path.
          </div>`);

      async function boot() {
        if (typeof miro?.onReady === 'function') await miro.onReady();

        // Try to fetch your panel file (200 OK expected)
        let panelOk = false;
        try {
          const r = await fetch(PANEL_URL, { cache: 'no-store' });
          panelOk = r.ok;
        } catch {}

        const urlToOpen = panelOk ? PANEL_URL : FALLBACK_URL;

        // Toolbar icon → open panel
        miro.board.ui.on('icon:click', () => {
          miro.board.ui.openPanel({ url: urlToOpen }).catch(()=>{});
        });

        // TEMP: auto-open so you can see it immediately (remove after it works once)
        await miro.board.ui.openPanel({ url: urlToOpen });

        try {
          await miro.board.notifications.showInfo(
            panelOk ? 'CoordsPanel loaded ✅' : `Opened fallback panel (check ${PANEL_FILE})`
          );
        } catch {}
      }

      // Only boot inside a Miro board
      let tries = 0, t = setInterval(async () => {
        if (window.miro && miro.board) {
          clearInterval(t);
          try { await boot(); } catch (e) { console.log('boot error', e); }
        } else if (++tries > 60) {
          clearInterval(t);
          console.log('SDK not detected in this iframe (runtime frame not launched?)');
        }
      }, 200);
    </script>
  </body>
</html>
